# ============================================================================
# Agent å­¦ä¹  Demo - ä¸€ä¸ªç®€å•çš„ä»»åŠ¡æ‰§è¡Œ Agent
# ============================================================================
# 
# è¿™ä¸ªç¨‹åºæ¼”ç¤ºäº†ä¸€ä¸ªåŸºç¡€çš„ Agent æ¶æ„ï¼š
# 1. Agent æ¥æ”¶ä»»åŠ¡
# 2. LLM åˆ†æä»»åŠ¡å¹¶å†³å®šä½¿ç”¨å·¥å…·æˆ–å®Œæˆä»»åŠ¡
# 3. å¦‚æœä½¿ç”¨å·¥å…·ï¼Œæ‰§è¡Œå·¥å…·å¹¶è·å–ç»“æœ
# 4. å°†ç»“æœåé¦ˆç»™ LLMï¼Œç»§ç»­å¾ªç¯ç›´åˆ°ä»»åŠ¡å®Œæˆ
# 
# ä½¿ç”¨å‰è¯·å…ˆå®‰è£…ä¾èµ–ï¼š
# pip3 install openai python-dotenv
# ============================================================================

# ----------------- å¯¼å…¥å¿…è¦çš„åº“ -----------------
import os          # ç”¨äºè®¿é—®ç¯å¢ƒå˜é‡
import json        # ç”¨äºè§£æ LLM è¿”å›çš„ JSON æ ¼å¼å“åº”
from openai import OpenAI  # OpenAI SDKï¼Œå…¼å®¹ DeepSeek API
from dotenv import load_dotenv  # ç”¨äºä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡

# ----------------- 1ï¸âƒ£ åˆå§‹åŒ– API å®¢æˆ·ç«¯ -----------------
# ä» .env æ–‡ä»¶ä¸­åŠ è½½ç¯å¢ƒå˜é‡ï¼ˆåŒ…å« API Keyï¼‰
# ç¡®ä¿ä½ çš„ .env æ–‡ä»¶ä¸­æœ‰ï¼šDEEPSEEK_API_KEY=your_api_key_here
load_dotenv()

# åˆ›å»º OpenAI å®¢æˆ·ç«¯å®ä¾‹
# æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨çš„æ˜¯ DeepSeek APIï¼Œå®ƒå…¼å®¹ OpenAI SDK çš„æ¥å£
client = OpenAI(
    api_key=os.getenv("DEEPSEEK_API_KEY"),  # ä»ç¯å¢ƒå˜é‡è·å– API Key
    base_url="https://api.deepseek.com"      # æŒ‡å®š DeepSeek çš„ API åœ°å€
)

# ----------------- 2ï¸âƒ£ å®šä¹‰ç³»ç»Ÿæç¤ºè¯ï¼ˆSystem Promptï¼‰-----------------
# ç³»ç»Ÿæç¤ºè¯ç”¨äºæŒ‡å¯¼ LLM çš„è¡Œä¸ºï¼Œå‘Šè¯‰å®ƒå¦‚ä½•æ‰®æ¼” Agent è§’è‰²
SYSTEM_PROMPT = """
ä½ æ˜¯ä¸€ä¸ªç®€å•çš„ä»»åŠ¡æ‰§è¡Œ Agentã€‚

ä½ å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š
1. æ¯ä¸€æ­¥åªèƒ½åšä¸€ä¸ªå†³å®š  # ç¡®ä¿ Agent æ¯æ¬¡åªæ‰§è¡Œä¸€ä¸ªæ“ä½œï¼Œé¿å…æ··ä¹±
2. ä½ å¿…é¡»ä»¥ JSON æ ¼å¼è¾“å‡º  # ä¾¿äºç¨‹åºè§£æå’Œå¤„ç†
3. å¦‚æœéœ€è¦ä½¿ç”¨å·¥å…·ï¼Œaction = "tool"  # è¡¨ç¤ºéœ€è¦è°ƒç”¨å·¥å…·
4. å¦‚æœä»»åŠ¡å®Œæˆï¼Œaction = "finish"  # è¡¨ç¤ºä»»åŠ¡å·²å®Œæˆï¼Œå¯ä»¥ç»“æŸå¾ªç¯

JSON æ ¼å¼å¦‚ä¸‹ï¼š
{
  "thought": "ä½ çš„æ€è€ƒ",        # Agent çš„æ€è€ƒè¿‡ç¨‹ï¼Œå¸®åŠ©ç†è§£å®ƒçš„å†³ç­–é€»è¾‘
  "action": "tool | finish",    # åŠ¨ä½œç±»å‹ï¼šä½¿ç”¨å·¥å…·æˆ–å®Œæˆä»»åŠ¡
  "tool_name": "...",           # å¦‚æœè¦ä½¿ç”¨å·¥å…·ï¼ŒæŒ‡å®šå·¥å…·åç§°
  "tool_args": {...}            # å·¥å…·çš„å‚æ•°ï¼Œä»¥å­—å…¸å½¢å¼ä¼ é€’
}
"""

# ----------------- 3ï¸âƒ£ å®šä¹‰å·¥å…·ï¼ˆToolsï¼‰-----------------
# å·¥å…·æ˜¯ Agent å¯ä»¥è°ƒç”¨çš„å‡½æ•°ï¼Œç”¨äºæ‰§è¡Œå…·ä½“ä»»åŠ¡

def calculator(expression: str) -> any:
    """
    è®¡ç®—å™¨å·¥å…·ï¼šæ‰§è¡Œæ•°å­¦è¡¨è¾¾å¼è®¡ç®—
    
    å‚æ•°:
        expression (str): è¦è®¡ç®—çš„æ•°å­¦è¡¨è¾¾å¼å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ "2 + 3 * 4"
    
    è¿”å›:
        any: è®¡ç®—ç»“æœï¼ˆæ•°å­—ï¼‰æˆ–é”™è¯¯ä¿¡æ¯ï¼ˆå­—ç¬¦ä¸²ï¼‰
    
    æ³¨æ„: ä½¿ç”¨ eval() æœ‰å®‰å…¨é£é™©ï¼Œä»…ç”¨äºæ¼”ç¤ºç›®çš„
          ç”Ÿäº§ç¯å¢ƒä¸­åº”è¯¥ä½¿ç”¨æ›´å®‰å…¨çš„è¡¨è¾¾å¼è§£æåº“ï¼ˆå¦‚ ast.literal_eval æˆ–ä¸“é—¨çš„æ•°å­¦åº“ï¼‰
    """
    try:
        # ä½¿ç”¨ eval() æ‰§è¡Œæ•°å­¦è¡¨è¾¾å¼
        # âš ï¸ è­¦å‘Šï¼ševal() å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ï¼Œå­˜åœ¨å®‰å…¨é£é™©
        # å®é™…é¡¹ç›®ä¸­åº”ä½¿ç”¨ ast.literal_eval() æˆ–ä¸“é—¨çš„æ•°å­¦è¡¨è¾¾å¼è§£æåº“
        return eval(expression)
    except Exception as e:
        # å¦‚æœè®¡ç®—å‡ºé”™ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
        return str(e)

# å·¥å…·æ³¨å†Œè¡¨ï¼šå°†å·¥å…·åç§°æ˜ å°„åˆ°å®é™…çš„å‡½æ•°
# è¿™æ · Agent å¯ä»¥é€šè¿‡åç§°æ¥è°ƒç”¨å¯¹åº”çš„å·¥å…·
TOOLS = {
    "calculator": calculator  # æ³¨å†Œè®¡ç®—å™¨å·¥å…·
    # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šå·¥å…·ï¼Œä¾‹å¦‚ï¼š
    # "web_search": web_search_function,
    # "file_reader": read_file_function,
}

# ----------------- 4ï¸âƒ£ Agent ä¸»å¾ªç¯å‡½æ•° -----------------
def run_agent(task: str):
    """
    Agent ä¸»å¾ªç¯ï¼šæ‰§è¡Œä»»åŠ¡çš„æ ¸å¿ƒå‡½æ•°
    
    å·¥ä½œæµç¨‹ï¼š
    1. åˆå§‹åŒ–æ¶ˆæ¯åˆ—è¡¨ï¼ˆåŒ…å«ç³»ç»Ÿæç¤ºå’Œç”¨æˆ·ä»»åŠ¡ï¼‰
    2. è¿›å…¥å¾ªç¯ï¼š
       a. è°ƒç”¨ LLM è·å–å†³ç­–
       b. è§£æ LLM è¿”å›çš„ JSON
       c. å¦‚æœ action == "finish"ï¼Œç»“æŸå¾ªç¯
       d. å¦‚æœ action == "tool"ï¼Œæ‰§è¡Œå·¥å…·å¹¶å°†ç»“æœåŠ å…¥æ¶ˆæ¯å†å²
    3. é‡å¤æ­¥éª¤ 2ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆ
    
    å‚æ•°:
        task (str): ç”¨æˆ·è¦æ‰§è¡Œçš„ä»»åŠ¡æè¿°
    """
    # åˆå§‹åŒ–æ¶ˆæ¯åˆ—è¡¨
    # messages ç”¨äºä¿å­˜ä¸ LLM çš„å¯¹è¯å†å²
    messages = [
        {"role": "system", "content": SYSTEM_PROMPT},  # ç³»ç»Ÿè§’è‰²ï¼šå®šä¹‰ Agent çš„è¡Œä¸ºè§„åˆ™
        {"role": "user", "content": task}              # ç”¨æˆ·è§’è‰²ï¼šç”¨æˆ·çš„ä»»åŠ¡è¯·æ±‚
    ]

    # ä¸»å¾ªç¯ï¼šæŒç»­æ‰§è¡Œç›´åˆ°ä»»åŠ¡å®Œæˆ
    while True:
        # ---------- æ­¥éª¤ 1: è°ƒç”¨ LLM è·å–å†³ç­– ----------
        # å‘ DeepSeek API å‘é€è¯·æ±‚ï¼Œè·å– Agent çš„å†³ç­–
        resp = client.chat.completions.create(
            model="deepseek-chat",      # ä½¿ç”¨çš„æ¨¡å‹åç§°
            messages=messages,          # å¯¹è¯å†å²ï¼ˆåŒ…å«ä¹‹å‰çš„äº¤äº’ï¼‰
            temperature=0               # æ¸©åº¦è®¾ä¸º 0ï¼Œç¡®ä¿è¾“å‡ºæ›´ç¡®å®šå’Œä¸€è‡´
        )

        # æå– LLM è¿”å›çš„å†…å®¹ï¼ˆåº”è¯¥æ˜¯ JSON æ ¼å¼ï¼‰
        content = resp.choices[0].message.content
        print("ğŸ¤– LLM å“åº”:", content)  # æ‰“å° LLM çš„åŸå§‹è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•

        # ---------- æ­¥éª¤ 2: è§£æ JSON å“åº” ----------
        try:
            # å°è¯•å°† LLM è¿”å›çš„å­—ç¬¦ä¸²è§£æä¸º JSON å¯¹è±¡
            result = json.loads(content)
        except json.JSONDecodeError:
            # å¦‚æœ JSON è§£æå¤±è´¥ï¼Œè¯´æ˜ LLM æ²¡æœ‰æŒ‰ç…§è¦æ±‚çš„æ ¼å¼è¾“å‡º
            print("âŒ JSON è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ¨¡å‹è¾“å‡ºæ ¼å¼")
            break  # é€€å‡ºå¾ªç¯ï¼Œé¿å…æ— é™å¾ªç¯

        # ---------- æ­¥éª¤ 3: åˆ¤æ–­åŠ¨ä½œç±»å‹ ----------
        action = result.get("action")  # è·å–åŠ¨ä½œç±»å‹

        # å¦‚æœ Agent å†³å®šå®Œæˆä»»åŠ¡
        if action == "finish":
            print("âœ… ä»»åŠ¡å®Œæˆï¼")
            print(f"ğŸ’­ Agent çš„æ€è€ƒ: {result.get('thought', 'æ— ')}")
            break  # é€€å‡ºå¾ªç¯ï¼Œä»»åŠ¡ç»“æŸ

        # å¦‚æœ Agent å†³å®šä½¿ç”¨å·¥å…·
        elif action == "tool":
            # è·å–å·¥å…·åç§°å’Œå‚æ•°
            tool_name = result.get("tool_name")      # å·¥å…·åç§°ï¼Œä¾‹å¦‚ "calculator"
            tool_args = result.get("tool_args", {})  # å·¥å…·å‚æ•°ï¼Œä¾‹å¦‚ {"expression": "2+3"}

            print(f"ğŸ”§ å‡†å¤‡è°ƒç”¨å·¥å…·: {tool_name}")
            print(f"ğŸ“ å·¥å…·å‚æ•°: {tool_args}")
            print(f"ğŸ’­ Agent çš„æ€è€ƒ: {result.get('thought', 'æ— ')}")

            # æ£€æŸ¥å·¥å…·æ˜¯å¦å·²æ³¨å†Œ
            if tool_name in TOOLS:
                # è°ƒç”¨å·¥å…·å‡½æ•°
                # **tool_args å°†å­—å…¸å±•å¼€ä¸ºå…³é”®å­—å‚æ•°
                # ä¾‹å¦‚ {"expression": "2+3"} ä¼šå˜æˆ calculator(expression="2+3")
                tool_result = TOOLS[tool_name](**tool_args)
                print(f"âœ… å·¥å…· {tool_name} æ‰§è¡ŒæˆåŠŸï¼Œè¿”å›ç»“æœ: {tool_result}")
            else:
                # å¦‚æœå·¥å…·ä¸å­˜åœ¨ï¼ŒæŠ¥é”™å¹¶é€€å‡º
                print(f"âŒ é”™è¯¯ï¼šæœªçŸ¥å·¥å…· '{tool_name}'")
                print(f"   å¯ç”¨å·¥å…·: {list(TOOLS.keys())}")
                break

            # ---------- æ­¥éª¤ 4: æ›´æ–°æ¶ˆæ¯å†å² ----------
            # å°† Agent çš„å“åº”æ·»åŠ åˆ°æ¶ˆæ¯å†å²ä¸­
            # è¿™æ · LLM åœ¨ä¸‹ä¸€è½®å¾ªç¯ä¸­å¯ä»¥çœ‹åˆ°ä¹‹å‰çš„å†³ç­–å’Œç»“æœ
            messages.append({
                "role": "assistant", 
                "content": content  # Agent çš„ JSON å“åº”
            })
            
            # å°†å·¥å…·æ‰§è¡Œç»“æœä¹ŸåŠ å…¥æ¶ˆæ¯å†å²
            # è¿™æ · LLM å¯ä»¥çœ‹åˆ°å·¥å…·çš„æ‰§è¡Œç»“æœï¼Œæœ‰åŠ©äºåšå‡ºä¸‹ä¸€æ­¥å†³ç­–
            messages.append({
                "role": "user",  # ä½¿ç”¨ user è§’è‰²æ¨¡æ‹Ÿå·¥å…·è¿”å›ç»“æœ
                "content": f"å·¥å…· {tool_name} çš„æ‰§è¡Œç»“æœ: {tool_result}"
            })

        else:
            # å¦‚æœ action æ—¢ä¸æ˜¯ "finish" ä¹Ÿä¸æ˜¯ "tool"ï¼Œè¯´æ˜æ ¼å¼ä¸æ­£ç¡®
            print(f"âŒ æœªçŸ¥çš„åŠ¨ä½œç±»å‹: {action}")
            print(f"   æœŸæœ›: 'tool' æˆ– 'finish'")
            break

# ----------------- 5ï¸âƒ£ ç¨‹åºå…¥å£ -----------------
if __name__ == "__main__":
    """
    å½“ç›´æ¥è¿è¡Œæ­¤è„šæœ¬æ—¶æ‰§è¡Œ
    è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼šè®© Agent è®¡ç®—ä¸€ä¸ªæ•°å­¦è¡¨è¾¾å¼
    """
    # è¿è¡Œ Agentï¼Œæ‰§è¡Œè®¡ç®—ä»»åŠ¡
    # run_agent("å¸®æˆ‘è®¡ç®— (23 * 7) + 19")
    
    # ä½ å¯ä»¥å°è¯•å…¶ä»–ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼š
    # run_agent("è®¡ç®— 100 é™¤ä»¥ 4 çš„ç»“æœ")
    run_agent("å¸®æˆ‘ç®—ä¸€ä¸‹ 2 çš„ 10 æ¬¡æ–¹")